<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Safe : simple backup for mysql, posgresql, svn and files to s3 or local filesystem" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Safe</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/astrails/safe">View on GitHub</a>

          <h1 id="project_title">Safe</h1>
          <h2 id="project_tagline">simple backup for mysql, posgresql, svn and files to s3 or local filesystem</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/astrails/safe/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/astrails/safe/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>astrails-safe</h1>

<p>Simple database and filesystem backups with S3 and Rackspace Cloud Files support (with optional encryption)</p>

<ul>
<li>Home: <a href="http://astrails.com/opensource/astrails-safe">http://astrails.com/opensource/astrails-safe</a>
</li>
<li>Code: <a href="http://github.com/astrails/safe">http://github.com/astrails/safe</a>
</li>
<li>Blog: <a href="http://blog.astrails.com/astrails-safe">http://blog.astrails.com/astrails-safe</a>
</li>
</ul><h2>Motivation</h2>

<p>We needed a backup solution that will satisfy the following requirements:</p>

<ul>
<li>opensource</li>
<li>simple to install and configure</li>
<li>support for simple ‘tar’ backups of directories (with includes/excludes)</li>
<li>support for simple mysqldump of mysql databases</li>
<li>support for symmetric or public key encryption</li>
<li>support for local filesystem, Amazon S3, and Rackspace Cloud Files for storage</li>
<li>support for backup rotation. we don’t want backups filling all the diskspace or cost a fortune on S3 or Cloud Files</li>
</ul><p>And since we didn't find any, we wrote our own :)</p>

<h2>Contributions</h2>

<p>The following functionality was contributed by astrails-safe users:</p>

<ul>
<li>PostgreSQL dump using <code>pg_dump</code> (by Mark Mansour <a href="mailto:mark@stateofflux.com">mark@stateofflux.com</a>)</li>
<li>Subversion dump using svndump (by Richard Luther <a href="mailto:richard.luther@gmail.com">richard.luther@gmail.com</a>)</li>
<li>SFTP remote storage (by Adam <a href="mailto:adam@mediadrive.ca">adam@mediadrive.ca</a>)</li>
<li>benchmarking output (By Neer)</li>
<li>README fixes (by Bobby Wilson)</li>
<li>improved config file parsing (by Fedor Kocherga <a href="mailto:fkocherga@gmail.com">fkocherga@gmail.com</a>)</li>
<li>mysql password file quoting (by Jonathan Sutherland <a href="mailto:jonathan.sutherland@gmail.com">jonathan.sutherland@gmail.com</a>)</li>
<li>Rackspace Cloud Files support (by H. Wade Minter <a href="mailto:minter@lunenburg.org">minter@lunenburg.org</a>)</li>
</ul><p>Thanks to all :)</p>

<h2>Installation</h2>

<pre><code>sudo gem install astrails-safe --source http://gemcutter.org
</code></pre>

<h2>Reporting problems</h2>

<p>Please report problems at the <a href="http://github.com/astrails/safe/issues">Issues tracker</a></p>

<h2>Usage</h2>

<pre><code>Usage:
   astrails-safe [OPTIONS] CONFIG_FILE
Options:
  -h, --help           This help screen
  -v, --verbose        be verbose, duh!
  -n, --dry-run        just pretend, don't do anything.
  -L, --local          skip remote storage, only do local backups
</code></pre>

<p>Note: CONFIG_FILE will be created from template if missing</p>

<h2>Encryption</h2>

<p>If you want to encrypt your backups you have 2 options:</p>

<ul>
<li>use simple password encryption</li>
<li>use GPG public key encryption</li>
</ul><blockquote>
<p>IMPORTANT: some gpg installations automatically set 'use-agent' option in the default
configuration file that is created when you run gpg for the first time. This will cause
gpg to fail on the 2nd run if you don't have the agent running. The result is that
'astrails-safe' will work ONCE when you manually test it and then fail on any subsequent run.
The solution is to remove the 'use-agent' from the config file (usually /root/.gnupg/gpg.conf)
To mitigate this problem for the gpg 1.x series '--no-use-agent' option is added by defaults
to the autogenerated config file, but for gpg2 is doesn't work. as the manpage says it:
"This is dummy option. gpg2 always requires the agent." :(</p>
</blockquote>

<p>For simple password, just add password entry in gpg section.
For public key encryption you will need to create a public/secret keypair.</p>

<p>We recommend to create your GPG keys only on your local machine and then
transfer your public key to the server that will do the backups.</p>

<p>This way the server will only know how to encrypt the backups but only you
will be able to decrypt them using the secret key you have locally. Of course
you MUST backup your backup encryption key :)
We recommend also pringing the hard paper copy of your GPG key 'just in case'.</p>

<p>The procedure to create and transfer the key is as follows:</p>

<ol>
<li><p>run 'gpg --gen-key' on your local machine and follow onscreen instructions to create the key
(you can accept all the defaults).</p></li>
<li><p>extract your public key into a file (assuming you used <a href="mailto:test@example.com">test@example.com</a> as your key email):
<code>gpg -a --export test@example.com &gt; test@example.com.pub</code></p></li>
<li><p>transfer public key to the server
<code>scp test@example.com.pub root@example.com:</code></p></li>
<li>
<p>import public key on the remote system:</p>

<p>$ gpg --import <a href="mailto:test@example.com.pub">test@example.com.pub</a>
gpg: key 45CA9403: public key "Test Backup <a href="mailto:test@example.com">test@example.com</a>" imported
gpg: Total number processed: 1
gpg:               imported: 1</p>
</li>
<li>
<p>since we don't keep the secret part of the key on the remote server, gpg has
no way to know its yours and can be trusted.
To fix that we can sign it with other trusted key, or just directly modify its
trust level in gpg (use level 5):</p>

<p>$ gpg --edit-key <a href="mailto:test@example.com">test@example.com</a>
 ...
 Command&gt; trust
 ...
 1 = I don't know or won't say
 2 = I do NOT trust
 3 = I trust marginally
 4 = I trust fully
 5 = I trust ultimately
 m = back to the main menu</p>

<p>Your decision? 5
 ...
 Command&gt; quit</p>
</li>
<li>
<p>export your secret key for backup
(we recommend to print it on paper and burn to a CD/DVD and store in a safe place):</p>

<p>$ gpg -a --export-secret-key <a href="mailto:test@example.com">test@example.com</a> &gt; <a href="mailto:test@example.com.key">test@example.com.key</a></p>
</li>
</ol><h2>Example configuration</h2>

<pre><code>safe do
  local :path =&gt; "/backup/:kind/:id"

  s3 do
    key "...................."
    secret "........................................"
    bucket "backup.astrails.com"
    path "servers/alpha/:kind/:id"
  end

  cloudfiles do
    user "..........."
    api_key "................................."
    container "safe_backup"
    path ":kind/" # this is default
    service_net false
  end

  sftp do
    host "sftp.astrails.com"
    user "astrails"
    # port 8023
    password "ssh password for sftp"
  end

  gpg do
    command "/usr/local/bin/gpg"
    options  "--no-use-agent"
    # symmetric encryption key
    # password "qwe"

    # public GPG key (must be known to GPG, i.e. be on the keyring)
    key "backup@astrails.com"
  end

  keep do
    local 20
    s3 100
    cloudfiles 100
    sftp 100
  end

  mysqldump do
    options "-ceKq --single-transaction --create-options"

    user "root"
    password "............"
    socket "/var/run/mysqld/mysqld.sock"

    database :blog
    database :servershape
    database :astrails_com
    database :secret_project_com do
      skip_tables "foo"
      skip_tables ["bar", "baz"]
    end

  end

  svndump do
    repo :my_repo do
      repo_path "/home/svn/my_repo"
    end
  end

  pgdump do
    options "-i -x -O"   # -i =&gt; ignore version, -x =&gt; do not dump privileges (grant/revoke), -O =&gt; skip restoration of object ownership in plain text format

    user "username"
    password "............"  # shouldn't be used, instead setup ident.  Current functionality exports a password env to the shell which pg_dump uses - untested!

    database :blog
    database :stateofflux_com
  end

  tar do
    options "-h" # dereference symlinks
    archive "git-repositories", :files =&gt; "/home/git/repositories"
    archive "dot-configs",      :files =&gt; "/home/*/.[^.]*"
    archive "etc",              :files =&gt; "/etc", :exclude =&gt; "/etc/puppet/other"

    archive "blog-astrails-com" do
      files "/var/www/blog.astrails.com/"
      exclude "/var/www/blog.astrails.com/log"
      exclude "/var/www/blog.astrails.com/tmp"
    end

    archive "astrails-com" do
      files "/var/www/astrails.com/"
      exclude ["/var/www/astrails.com/log", "/var/www/astrails.com/tmp"]
    end
  end
end
</code></pre>

<h2>Copyright</h2>

<p>Copyright (c) 2010 Astrails Ltd. See LICENSE for details.</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Safe maintained by <a href="https://github.com/astrails">astrails</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
